\documentclass{beamer}
\usepackage{minted}
\usepackage{hyperref}
\usetheme{metropolis}
\title{Flask web evaluation for QtRvSim}
% March 16th 2024
\date{16.3.2024}
\author{Jakub Pelc}
\institute{Faculty of Electrical Engineering, Czech Technical University in Prague}
\begin{document}
	\maketitle
	\section{Goals of this project}
	\begin{frame}{Flask}
		The main aim of this project is to provide a way for students (and general public) to test their knowledge of the RISC-V assembly.

		Registered users can submit solutions to the problems displayed on the frontpage and get immediate feedback on their solution.
		The solution performance is measured (in cycles needed to execute the submission), and local scoreboard is displayed for each task.\par

		The project needed to be rather simple, for it to allow easy modularity and optional modification in the future. It can be expanded by
		more features, language support, or task types.
	\end{frame}

	\begin{frame}{GDPR}
		We are not saving the email adresses of the users (due to GDPR), but during the registration process, the users are required to provide an email address for verification purposes. So how is that achieved?\par

		The email address is saved as a salted \texttt{SHA-256} hash. This way, we can verify the email address, but we cannot reverse the hash to obtain the original email address. \par

		This also allows us to send the user a password reset link, without having to store the email address in readable format. User always need to provide the email address, which is checked against the hash in the database.
	\end{frame}
	
	\section{A little bit about Flask}
	
	\begin{frame}{Flask}
		Flask is a micro web framework written in Python. It provides a simple way to create web applications. \par

		As opposed to Django, Flask is not an all-inclusive framework. It is designed to be simple and easy to use. \par

		To start creating a web application, the only thing you need to do is to install Flask and start writing your Python code.

		To run the local webserver, the command \texttt{flask run} is used.

	\end{frame}

	\begin{frame}[fragile]
		\begin{minted}{python}
	from flask import Flask

	app = Flask(__name__)

	@app.route("/")
	def hello():
		return "<p>Hello, World!</p>"
		\end{minted}
	\end{frame}

	\begin{frame}{Loading template files}
		We can utilize Flask to load HTML templates, instead of writing all of the HTML code in the \texttt{app.py} file. \par
		
		These template file are to be located in the \texttt{templates} directory. \par

		For this example, we will use the standard HTML.
	\end{frame}


	\begin{frame}[fragile]
		\small
		\inputminted{python}{examples/2/app.py}
	\end{frame}

	\begin{frame}{Jinja2 templating}
		This is still not ideal, now we need to create a complete HTML page for every route. \par

		We will now use the Jinja2 templating engine to create a base template, and then extend it for every route.

		We can also add static files, such as CSS stylesheets, or images. \par
	\end{frame}

	\begin{frame}[fragile]
		\tiny
		\inputminted{html}{examples/3/templates/base.html}
	\end{frame}

	\begin{frame}[fragile]
		\small
		\inputminted{html}{examples/3/templates/register.html}
	\end{frame}

	\begin{frame}{Flask sessions}
		The session system allows us to store information about the user across multiple requests. \par

		We can also pass variables to the template which we will use while rendering the page. \par

		This can be demonstrated by creating a simple login system.
	\end{frame}


	\begin{frame}[fragile]
		\tiny
		\inputminted{python}{examples/4/app.py}
	\end{frame}

	\section{Database}

	\begin{frame}{Communication with the database}
		In the web application, a PostgreSQL database is used. \par

		Only a few tables are needed to store the information about the users, tasks, submissions and results. \par

		PostgreSQL triggers are used to automatically update the best score and source code. 
	\end{frame}

	\begin{frame}{Users Table}
		\begin{tabular}{|l|l|l|l|}
		\hline
		Field & Type & Length & Default \\
		\hline
		id & int & 32 & AUTO\_INCREMENT \\
		username & varchar & 128 & None \\
		password & varchar & 128 & None \\
		email & varchar & 128 & None \\
		salt & varchar & 128 & None \\
		verification\_code & varchar & 128 & None \\
		user\_verified & tinyint & 1 & 0 \\
		\hline
		\end{tabular}
		\end{frame}

		\begin{frame}{Submissions Table}
			\begin{tabular}{|l|l|l|l|}
			\hline
			Field & Type & Length & Default \\
			\hline
			id & int & 64 & AUTO\_INCREMENT \\
			userid & int & 64 & None \\
			taskid & int & 64 & None \\
			file & text & 64 & None \\
			evaluated & tinyint & 1 & 0 \\
			time & datetime & None & current\_timestamp() \\
			\hline
			\end{tabular}
		\end{frame}

		\begin{frame}{Results Table}
			\small
			\begin{tabular}{|l|l|l|}
			\hline
			Field & Type & Default \\
			\hline
			userid & bigint & PRIMARY \\
			taskid & bigint & PRIMARY \\
			result\_file & text & NULL \\
			last\_source & text & NULL \\
			best\_source & text & NULL \\
			score\_last & integer & -1 \\
			score\_best & integer & -1 \\
			time & timestamp with time zone & CURRENT\_TIMESTAMP \\
			result & smallint & -1 \\
			\hline
			\end{tabular}
		\end{frame}

		\begin{frame}[fragile]
			\begin{minted}{python}
import psycopg2
import os

db_config = {
	'user': os.getenv('DB_USER'),
	'password': os.getenv('DB_PASSWORD'),
	'host': os.getenv('DB_HOST'),
	'database': os.getenv('DB_DATABASE'),
	'port': os.getenv('DB_PORT'),
	'sslmode': 'require',
	'connect_timeout': 10
}
			\end{minted}
		\end{frame}

		\begin{frame}[fragile]
			\begin{minted}{python}

def connect():
	db = psycopg2.connect(**db_config)
	cursor = db.cursor()
	return (db, cursor)

def get_user(username):
  (db, cursor) = connect()
  cursor.execute('SELECT password FROM \
	users WHERE username = %s', (username,))
  user = cursor.fetchone()
  cursor.close()
  db.close()
  return user
	
			\end{minted}
		\end{frame}

		\section{Evaluation using QtRvSim}

		\begin{frame}{Submission evaluation}
			Each of the submissions is being evaluated by a \texttt{qtrvsim\_cli} python wrapper \href{https://gitlab.fel.cvut.cz/b35apo/qtrvsim-eval-web/-/blob/main/evaluator/qtrvsim.py}{\texttt{qtrvsim.py}}. \par
	
			For each task, there is a \texttt{.toml} file, which is parsed using an evaluator script. The parsed data is used to create a new QtRvSim instance, which evaluates all the testcases in the task file. \par
	
			The result, score, and the log is then displayed to the user.
		\end{frame}
	
		\begin{frame}[fragile]
			\tiny
			\inputminted{python}{examples/5/evaluate.py}
		\end{frame}

		\begin{frame}[fragile]
			\tiny
			\inputminted{toml}{examples/5/task.toml}
		\end{frame}

		\begin{frame}{Advanced tasks}
			The evaluator is also able to set a cache for the task, whose parameters are configurable as a part of the task. This is done by setting the maximum cache size for the task, users are then required to configure the cache parameters. \par

			Serial input and output can also be used. \par

			It is also possible, to create a task in \texttt{C}, but this also requires a custom Makefile to be provided in the taskfile. If custom files need to be present at compile time, they can also be added. \par
		\end{frame}

		\begin{frame}[fragile]
			\small
			\inputminted{toml}{examples/5/cache.toml}
		\end{frame}

		\begin{frame}[fragile]
			\tiny
			\inputminted{toml}{examples/5/complex.toml}
		\end{frame}

	\section{Mini Competition}

	\begin{frame}{Mini Competition}
		On the page \par
		{\centering \texttt{\href{http://eval.comparch.edu.cvut.cz}{eval.comparch.edu.cvut.cz}} \par}
		you can try out your skills in RISC-V assembly. \par

		For each task the best five users will acquire $(6 - p)$ points, where p is the place they finished (according to the cycles needed to execute their solution). \par

		We offer FEE CTU merch for the best users, who submit their solutions before TODO:17.3. 15:00. \par
	\end{frame}

	\section{References}

	\begin{frame}{References}
		Links and references: \par
		{\centering \texttt{\href{https://flask.palletsprojects.com/en/3.0.x/}{Flask}} \par}
		{\centering \texttt{\href{http://eval.comparch.edu.cvut.cz}{eval.comparch.edu.cvut.cz}} \par}
		{\centering \texttt{\href{http://comparch.edu.cvut.cz}{comparch.edu.cvut.cz}} \par}
		{\centering \texttt{\href{https://github.com/cvut/qtrvsim}{QtRvSim repository}} \par}
		{\centering \texttt{\href{https://gitlab.fel.cvut.cz/b35apo/qtrvsim-eval-web}{Web Eval repository}} \par}
		{\centering \texttt{\href{https://swpelc.eu}{Jakub Pelc}} \par}
	\end{frame}

\end{document}